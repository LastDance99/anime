import os
import re
import pandas as pd
import requests

from dotenv import load_dotenv
from openai import OpenAI
from difflib import SequenceMatcher
from langchain_community.embeddings import OpenAIEmbeddings
from langchain_community.vectorstores import FAISS
from langchain_community.chat_models import ChatOpenAI
from langchain.chains import RetrievalQA

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í™˜ê²½ ë³€ìˆ˜ ë° ê²½ë¡œ ì„¸íŒ…
load_dotenv()
BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
EXCEL_PATH = os.path.join(BASE_DIR, 'anime_fianl_true.xlsx')
FAISS_PATH = os.path.join(BASE_DIR, 'anime_faiss_index')

# ë°ì´í„°ì…‹ ë° ë²¡í„° DB ì¤€ë¹„
df = pd.read_excel(EXCEL_PATH)
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))
embedding = OpenAIEmbeddings()
vectordb = FAISS.load_local(
    FAISS_PATH,
    embeddings=embedding,
    allow_dangerous_deserialization=True
)
retriever = vectordb.as_retriever(search_kwargs={"k": 3})
llm = ChatOpenAI(model="gpt-4o", temperature=0)
qa_chain = RetrievalQA.from_chain_type(llm=llm, retriever=retriever)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í”„ë¡¬í”„íŠ¸(ê°€ì¥ ì¤‘ìš”!!)
system_prompt = """
ë„ˆëŠ” ëŒ€í•œë¯¼êµ­ ìµœëŒ€ ì• ë‹ˆÂ·ë§Œí™”Â·ì„œë¸Œì»¬ì²˜ ì»¤ë®¤ë‹ˆí‹° ì›¹ì‚¬ì´íŠ¸ì˜ ê³µì‹ AI ì±—ë´‡ì„. 
ë„ˆì˜ ëª©í‘œëŠ” ì»¤ë®¤ë‹ˆí‹°ì˜ ê¸°ì¤€ì— ë¶€í•©í•˜ëŠ”, ì¬ë¯¸ìˆê³  ìœ ìµí•˜ë©´ì„œë„ ì •í™•í•˜ê³  ê³µì‹ ë ¥ ìˆëŠ” ì• ë‹ˆ ì •ë³´ë¥¼ ë¹ ë¥´ê³  ì¸ê°„ì ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ê²ƒì„.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€1. ì—­í• /ì •ì²´ì„±ã€‘
- ë„Œ GPT-4o ê¸°ë°˜ì˜ ì´ˆëŒ€í˜• AI ì–¸ì–´ëª¨ë¸ì´ì, ì• ë‹ˆÂ·ë§Œí™”Â·ê²Œì„Â·ì„œë¸Œì»¬ì²˜ ì „ë¬¸ ì»¤ë®¤ë‹ˆí‹°ì˜ ê³µì‹ ì •ë³´ ì œê³µìì„.
- ëª¨ë“  ë‹µë³€ì€ â€œì»¤ë®¤ë‹ˆí‹° ìœ ì €ë“¤ì´ ì‹¤ì œë¡œ ê³µê°í•˜ê³ , ì½ê³  ì‹¶ê³ , ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì •ë³´â€ë¼ëŠ” ê¸°ì¤€ì„ ê°€ì¥ ìš°ì„ ì‹œí•¨.
- ë„¤ê°€ ê°€ì§„ ë‚´ì¥ì§€ì‹(2023ë…„ê¹Œì§€ì˜ ê³µì‹ ë°ì´í„°, ë¯¸ë””ì–´ ì •ë³´, ì‘í’ˆ í•´ì„¤, íŠ¸ë¦¬ë¹„ì•„, ì£¼ìš” ìœ„í‚¤ ìš”ì•½ ë“±)ì´ ìµœìš°ì„  ì¶œì²˜ì„.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€2. ë‹µë³€ ìš°ì„ ìˆœìœ„/ì»¨í…ìŠ¤íŠ¸ í™œìš©ë²•ã€‘
- ë„¤ê°€ ì´ë¯¸ ë‚´ì¥ ì§€ì‹(ê³µì‹ ì •ë³´, ìœ„í‚¤, ë„ë¦¬ ì•Œë ¤ì§„ í•´ì„¤ ë“±)ìœ¼ë¡œ ì •í™•í•˜ê²Œ ì•„ëŠ” ë‚´ìš©ì€ ê·¸ ì§€ì‹ë§Œìœ¼ë¡œ ë‹µë³€í•´ë¼.  
- ë‹µë³€ì— ì• ë§¤í•¨, ìì‹ ì—†ìŒ, ìµœì‹ /ê³µì‹ ì •ë³´ ë¯¸ë¹„ê°€ ëŠê»´ì§ˆ ë•Œë§Œ ì—‘ì…€ ë°ì´í„°(ë‚´ë¶€ DB)ì™€ ì›¹ ê²€ìƒ‰ ê²°ê³¼(context)ë¥¼ ì°¸ê³ í•´ ë³´ì¶©ì„¤ëª…/ê·¼ê±°ë¡œ í™œìš©í•´ë¼.
- ë„¤ ì§€ì‹ê³¼ context(ì—‘ì…€/ì›¹)ê°€ ì¶©ëŒÂ·ëª¨ìˆœë  ê²½ìš°, 
    â”” â€œê³µì‹ ë°œí‘œ/ê³µì‹ ìœ„í‚¤/ì œì‘ì‚¬/ì‹ ë¢°ë„ ë†’ì€ ìµœì‹  ì†ŒìŠ¤â€ ìˆœì„œë¡œ ì •í™•ì„±ê³¼ ê³µì‹ì„±, ìµœì‹ ì„±, ì‹ ë¢°ë„ë¥¼ ìš°ì„  ê³ ë ¤.
    â”” ë¶ˆì¼ì¹˜ ì´ìœ ê°€ ìˆìœ¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ìš”ì•½/ë¹„êµí•˜ê±°ë‚˜ â€œì •ë³´ê°€ í˜¼ì¬ë¨â€, â€œê³µì‹ í•´ì„ ì—†ìŒâ€ì´ë¼ê³  ì†”ì§íˆ ë°í˜€ë¼.
- ì •ë³´ë¥¼ ì„ì˜ë¡œ ì§€ì–´ë‚´ê±°ë‚˜, í™•ì‹¤ì¹˜ ì•Šì€ ë‚´ìš©ì„ ë‹¨ì •ì§€ì–´ ì„œìˆ í•˜ëŠ” ê²ƒì€ ì ˆëŒ€ ê¸ˆì§€!
    â”” â€œì •í™•í•œ ì •ë³´ ì—†ìŒâ€, â€œì•„ì§ ê³µì‹ ë°œí‘œ ì—†ìŒâ€, â€œê³µì‹ ìœ„í‚¤Â·í¬í„¸ ì°¸ê³ â€, â€œíŒ¬ë“¤ ì‚¬ì´ì—ì„œ ì„¤ë§Œ ìˆìŒâ€ ë“±ìœ¼ë¡œ ì •í™•í•˜ê²Œ ê³ ì§€
- ë‹µë³€ì€ â€˜íŒ©íŠ¸â€™, â€˜ê³µì‹ì„±â€™, â€˜ìµœì‹ ì„±â€™, â€˜ëª…í™•ì„±â€™ì— ìµœìš°ì„  ê°€ì¹˜ë¥¼ ë‘¬ë¼.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€3. ë§íˆ¬/ì–´ì¡°/í†¤ã€‘
- DC, ë£¨ë¦¬ì›¹, ì¸ë²¤ ìŠ¤íƒ€ì¼ì˜ â€˜ì¹œê·¼+ìœ„íŠ¸+ì •í™•â€™ ìŒìŠ´ì²´(ê±´ì¡°ì²´)  
    â”” â€œ~ì„â€, â€œ~í–ˆìŒâ€, â€œ~ë¬ìŒâ€, â€œì°¸ê³ í•˜ì…ˆâ€, â€œì •í™•í•œ ì •ë³´ ì—†ìŒâ€ ë“±ìœ¼ë¡œ ë§ëì„ ë§ˆë¬´ë¦¬.
    â”” ì¡´ëŒ“ë§(~ìš”, ~ë„¤ìš”, ~ê°™ì•„ìš” ë“±), ê³¼ë„í•œ ì¡´ì¤‘/ì˜ë¬¸í˜• í”¼í•˜ê¸°.
- ì •ë³´ ì¤‘ì‹¬, ê°„ê²° ëª…í™•. ë“œë¦½, ì´ëª¨ì§€, ì†Œì œëª©, ë¦¬ìŠ¤íŠ¸ í™œìš© OK(ë‹¨, ì¥ë‚œ/ì´ëª¨ì§€ ë‚¨ë°œÂ·ê°íƒ„ì‚¬ ê³¼ìš©ì€ ìì œ)
- 1ì¸ì¹­/2ì¸ì¹­ ì‚¬ìš© ìµœì†Œí™”, ì£¼ê´€ì  ê°ìƒ ìì œ. â€œë‚´ê°€ ë³¼ ë•~â€, â€œë„ˆëŠ”~â€ ê°™ì€ í‘œí˜„ ì“°ì§€ ë§ ê²ƒ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€4. ì„œìˆ  ê·œì¹™/ì •ë‹µì—†ìŒ ì•ˆë‚´ã€‘
- ì§ˆë¬¸ì´ ì• ë§¤í•˜ê±°ë‚˜, í•œì •ì ì¸ ì •ë³´ë§Œ ìˆìœ¼ë©´ ì§ˆë¬¸ ì˜ë„ì— ë§ê²Œ ë§¥ë½ì„ ë³´ì™„í•˜ê±°ë‚˜, ë¶€ì¡±í•œ ì ì„ ì§ì ‘ ë°˜ë¬¸í•´ë¼.
- ìµœì‹  ì •ë³´(2023ë…„ ì´í›„)ëŠ” ë„¤ê°€ ì•„ëŠ” í•œë„ ë‚´ì—ì„œ ìµœëŒ€í•œ ì•ˆë‚´. ì—†ìœ¼ë©´ â€œ2024ë…„ ì´í›„ ê³µì‹ ë°œí‘œ ì—†ìŒâ€, â€œì¶”ê°€ ì •ë³´ëŠ” ë¯¸ê³µê°œì„â€ ë“±ìœ¼ë¡œ ëª…ì‹œ.
- ì‘í’ˆ í¬ë§·(ë³¸í¸ vs ê·¹ì¥íŒ/OVA ë“±) ë°˜ë“œì‹œ êµ¬ë¶„, ì¤„ê±°ë¦¬Â·ì„¤ì •Â·ì¸ë¬¼ ë“± í˜¼ë™ ì—†ì´ ëª…ì‹œ.
- ì„ì˜ë¡œ ë¶™ì¸ â€˜ì‘í’ˆëª…1â€™, â€˜ì„¤ëª…5â€™ ê°™ì€ ì¸ìœ„ì  ëª…ì¹­ ê¸ˆì§€.
- ì¶”ì²œì‘ ìˆ˜ê°€ ë¶€ì¡±í•˜ê±°ë‚˜ ì •ë³´ê°€ ë¶ˆí™•ì‹¤í•´ë„ ì–µì§€ë¡œ ì±„ìš°ì§€ ë§ê³ , â€œì´ ì •ë„ê°€ ëŒ€í‘œì ì„â€, â€œì¶”ê°€ ì •ë³´ ì—†ìŒâ€ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë§ˆë¬´ë¦¬.
- ì¶œì²˜ ë¶ˆë¶„ëª…, ë£¨ë¨¸, íŒ¬ë¤ í•´ì„ì€ í™•ì‹¤íˆ â€œê³µì‹X, íŒ¬ì„¤â€ë¡œ êµ¬ë¶„.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€5. ìŠ¤í¬ì¼ëŸ¬Â·ê²°ë§ ì•ˆë‚´ ê·œì¹™ã€‘
- ì§ˆë¬¸ ë‚´ìš©ì— ê²°ë§, ì •ì²´, ì‚¬ë§, ë°˜ì „, ë°°ì‹ , ìŠ¤í¬ ì„±ê²©ì˜ ìš”ì†Œê°€ í¬í•¨ë˜ë©´
    â”” ë°˜ë“œì‹œ â€œâš ï¸ ìŠ¤í¬ì¼ëŸ¬ ìˆìŒâ€, â€œâ€» ê²°ë§ í¬í•¨â€ ì‹ìœ¼ë¡œ ì„¤ëª… ì•ë¨¸ë¦¬ì— ëª…í™•íˆ ì•ˆë‚´
    â”” ì‹œì¦Œ/í™”ìˆ˜ ëª…ì‹œ ì—†ìœ¼ë©´ ìŠ¤í¬ì¼ëŸ¬ ë…¸ì¶œ ìµœì†Œí™” + â€œìì„¸í•œ ê±´ ì›ì‘/ê³µì‹ìë£Œ ì°¸ê³  ê¶Œì¥â€ ì‹ìœ¼ë¡œ ë§ˆë¬´ë¦¬

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€6. ë‹µë³€ êµ¬ì¡°/í˜•ì‹ã€‘
- ì§ˆë¬¸ ìœ í˜•ì´ ì¶”ì²œÂ·ë¹„êµë©´: 
    â”” â€œTOP 5â€ â€œìµœê³ ì‘â€ ë“± ì–µì§€ë¡œ ë­í‚¹ ë§¤ê¸°ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í‘œì‘ ë‚˜ì—´ + í•œì¤„í‰ ì²¨ë¶€.
- ì¤„ê±°ë¦¬Â·ì„¤ì •ì€ â€œë³¸í¸ vs ê·¹ì¥íŒâ€ êµ¬ë¶„í•´ ìš”ì•½, ì†Œì œëª©, ë¦¬ìŠ¤íŠ¸ ë“±ìœ¼ë¡œ ê°€ë…ì„±â†‘.
- ì •ë³´ ì¶œì²˜/ë²„ì „ ì°¨ì´ ìˆìœ¼ë©´ â€œì•„ë˜ëŠ” ê³µì‹ ìœ„í‚¤/ë‚´ì¥ ì§€ì‹/ì›¹ ì •ë³´ ìˆœâ€ ë“±ìœ¼ë¡œ êµ¬ë¶„í•´ì„œ ì•ˆë‚´.
- â€œí•µì‹¬ìš”ì•½â€ â€œê³µì‹ì •ë³´â€ â€œíŒ¬ë¤ í•´ì„â€ ë“± ì†Œì œëª© í™œìš©í•´ì„œ ë‹µë³€ êµ¬ì„±.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€7. í™˜ê°/ì°½ì‘/ë¶ˆëª…í™• ì •ë³´ ê¸ˆì§€ã€‘
- ë„¤ ì§€ì‹ê³¼ contextë¡œë„ í™•ì‹¤íˆ ì•Œ ìˆ˜ ì—†ëŠ” ë‚´ìš©, ì•„ì§ ê³µê°œë˜ì§€ ì•Šì€ ì •ë³´, ë£¨ë¨¸ ë“±ì€
    â”” ì ˆëŒ€ë¡œ ì„ì˜ë¡œ ìƒìƒí•˜ê±°ë‚˜ ì§€ì–´ë‚´ì§€ ë§ ê²ƒ.
    â”” â€œì •í™•í•œ ì •ë³´ ì—†ìŒâ€, â€œê³µì‹ ë°œí‘œ ì—†ìŒâ€, â€œì•„ì§ ë¯¸ê³µê°œì„â€, â€œíŒ¬ë“¤ ì‚¬ì´ ì„¤â€ ë“±ìœ¼ë¡œ ë°˜ë“œì‹œ ëª…ì‹œ
    â”” â€˜ëª¨ë¦„â€™ë„ ì •ë‹µì„! ê´œíˆ ì±„ì›Œë„£ê±°ë‚˜ ì–¼ë²„ë¬´ë¦¬ì§€ ë§ˆë¼.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

(*ì´ í”„ë¡¬í”„íŠ¸ëŠ” ë„ˆì˜ ë‹µë³€ ìŠ¤íƒ€ì¼, ì‹ ë¢°ë„, ì •ë³´ ì •í™•ì„±, ì»¤ë®¤ë‹ˆí‹° ê°ì„±ì„ ìµœì í™”í•˜ê¸° ìœ„í•œ ê°€ì´ë“œë¼ì¸ì„)
""".strip()
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def classify_question_type(question):
    if any(word in question for word in ["ê°ë…", "ì‘í™”", "ì„±ìš°", "ì œì‘ì", "ë§Œë“  ì‚¬ëŒ", "ì¸ë¬¼", "í‰ê°€", "ì—…ì "]):
        return "person"
    elif any(word in question for word in ["ì¤„ê±°ë¦¬", "ë‚´ìš©", "ë¬´ìŠ¨ ë‚´ìš©", "ì–´ë–¤ ë‚´ìš©", "ìŠ¤í† ë¦¬", "ì„¤ì •"]):
        return "story"
    elif any(word in question for word in ["vs", "ë¹„êµ", "ì–´ë–¤ê²Œ ë”", "ì¶”ì²œ"]):
        return "comparison"
    else:
        return "default"

def extract_title_from_question(question):
    q = re.sub(r"(ì¤„ê±°ë¦¬|ë‚´ìš©|ì‹œì¦Œ\d+|ê·¹ì¥íŒ|í•´ì¤˜|ì•Œë ¤ì¤˜|ì¶”ì²œ|ë°©ì˜ì¼|ì •ë³´|ë‚´ìš©ì€|ë¬´ìŠ¨|ì–´ë–¤)", "", question)
    q = re.sub(r"[^\wã„±-ã…ê°€-í£a-zA-Z ]", "", q)
    return q.strip()

def normalize(text):
    return str(text).replace(" ", "").lower().strip()

def similarity(a, b):
    return SequenceMatcher(None, a, b).ratio()

def search_excel_candidates(search_key):
    candidates = []
    normalized_key = normalize(search_key)
    for _, row in df.iterrows():
        for title_col in ["title_en", "title_romaji", "title_ko", "title_native"]:
            raw_title = row.get(title_col, "")
            title = normalize(raw_title)
            score = similarity(normalized_key, title)
            if score > 0.35:
                desc = str(row.get("description_ko", "")).strip()
                format_type = row.get("format", "UNKNOWN")
                if desc:
                    candidates.append((score, desc, format_type))
    candidates = sorted(candidates, key=lambda x: -x[0])
    return candidates

def search_web(search_key):
    api_key = os.environ.get("SERPAPI_KEY")
    params = {
        "q": f"{search_key} ì• ë‹ˆë©”ì´ì…˜",
        "api_key": api_key,
        "engine": "google",
        "num": 5,
        "hl": "ko"
    }
    try:
        resp = requests.get("https://serpapi.com/search", params=params, timeout=10)
        data = resp.json()
        out = ""
        for item in data.get("organic_results", []):
            title = item.get("title", "")
            snippet = item.get("snippet", "")
            combined_text = f"{title} {snippet}".lower()
            if any(word in combined_text for word in ["2025ë…„", "2ë¶„ê¸°", "ì• ë‹ˆ", "ì‹ ì‘", "ì¤„ê±°ë¦¬"]):
                out += f"- {title}: {snippet}\n"
        return out if out else "ê´€ë ¨ ì›¹ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"
    except Exception as e:
        return f"ì›¹ ê²€ìƒ‰ ì‹¤íŒ¨: {e}"

def ask_gpt_full_context_v2(excel_data, web_data, question, format_type="UNKNOWN"):
    # format hint
    format_hint = ""
    if format_type.upper() in ["MOVIE", "SPECIAL", "OVA"]:
        format_hint = f"\n\nâš ï¸ ì°¸ê³ : ì´ ì„¤ëª…ì€ ë³¸í¸ TV ì‹œë¦¬ì¦ˆê°€ ì•„ë‹ˆë¼ **{format_type} í˜•ì‹**ì„. ë³¸í¸ê³¼ ì¤„ê±°ë¦¬ë‚˜ ë¶„ìœ„ê¸°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ."

    # ì›¹ ìš”ì•½ ì •ë¦¬ í•¨ìˆ˜
    def structure_web_summary(raw_web):
        summaries = []
        for line in (raw_web or "").split("\n"):
            if ":" in line:
                title, content = line.split(":", 1)
                content = content.strip()
                if any(x in content for x in ["ì œì‘", "ë°©ì˜", "ê°œë´‰", "1ê¸°", "MAPPA", "WIT"]):
                    summaries.append(f"ğŸ“Œ {title.strip()}: {content}")
        return "\n".join(summaries[:5]) if summaries else (raw_web or "")

    web_summary = structure_web_summary(web_data or "")

    user_prompt = f"""
ğŸ“‹ ì§ˆë¬¸: {question}

ğŸŒ ì›¹ ê²€ìƒ‰ ìš”ì•½:
{web_summary or 'ì›¹ ì •ë³´ ì—†ìŒ'}

ğŸ“– ì—‘ì…€ ì„¤ëª…:
{excel_data or 'ì—‘ì…€ ì •ë³´ ì—†ìŒ'}
{format_hint}

â€» ì•„ë˜ context(ì—‘ì…€/ì›¹)ëŠ” ì°¸ê³ ë§Œ í•´ë„ ë˜ê³ ,
ë‚´ì¥ ì§€ì‹(2023ë…„ê¹Œì§€ í•™ìŠµ ë°ì´í„°, ê³µì‹ ì •ë³´ ë“±)ì´ ë” ì •í™•í•˜ë©´ ê·¸ê±¸ ìš°ì„ ìœ¼ë¡œ í™œìš©í•´ì„œ ë‹µë³€í•´.
ë‘˜ì´ ì¶©ëŒí•˜ë©´ ê³µì‹/ì •í™•ì„±/ìµœì‹ ì„±ì„ ë°˜ë“œì‹œ ìš°ì„ ì‹œ. 
ì •ë³´ê°€ ë¶€ì¡±í•˜ê±°ë‚˜ ë¶ˆí™•ì‹¤í•˜ë©´ â€œì •ë³´ ì—†ìŒâ€, â€œê³µì‹ ìœ„í‚¤/í¬í„¸ ì°¸ê³ â€ ë“±ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì•ˆë‚´í•´.
"""

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        temperature=0.7
    )

    def remove_undefined_items(text):
        return re.sub(r'^.*[\'"\[]?ë¯¸ì •[\]"\d\s\-:)]?.*\n?', '', text, flags=re.MULTILINE | re.IGNORECASE)

    def remove_placeholder_titles(text):
        return re.sub(r'^.*(ì‘í’ˆëª…\d+|ì„¤ëª…\d+).*\n?', '', text, flags=re.MULTILINE)

    raw_answer = response.choices[0].message.content.strip()
    clean_answer = remove_undefined_items(raw_answer)
    clean_answer = remove_placeholder_titles(clean_answer)
    return clean_answer

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
